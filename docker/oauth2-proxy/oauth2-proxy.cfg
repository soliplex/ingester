# OAuth2 Proxy Configuration for Soliplex Ingester
# See: https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview
#
# This configuration supports generic OIDC providers (Keycloak, Auth0, Okta, Azure AD, etc.)
# Copy this file and customize for your environment.

## Provider Configuration
# Use 'oidc' for generic OpenID Connect providers
# Use 'keycloak-oidc' for Keycloak-specific features (roles, groups)
provider = "oidc"
provider_display_name = "SSO"

# OIDC Discovery URL - set via environment variable OAUTH2_PROXY_OIDC_ISSUER_URL
# Examples:
#   Keycloak: https://keycloak.example.com/realms/your-realm
#   Auth0:    https://your-tenant.auth0.com/
#   Okta:     https://your-org.okta.com
#   Azure AD: https://login.microsoftonline.com/{tenant-id}/v2.0

# Client credentials - set via environment variables:
#   OAUTH2_PROXY_CLIENT_ID
#   OAUTH2_PROXY_CLIENT_SECRET

## Proxy Behavior
http_address = "0.0.0.0:4180"
reverse_proxy = true

# Upstream applications (API and UI served from same container)
upstreams = [
    "http://soliplex_ingester:8000"
]

## Cookie Configuration
cookie_name = "_soliplex_auth"
cookie_secure = true
cookie_httponly = true
cookie_samesite = "lax"
# cookie_secret is required - generate with: openssl rand -base64 32 | tr -- '+/' '-_'
# Set via environment variable: OAUTH2_PROXY_COOKIE_SECRET

# Cookie expiration (default 168h = 7 days)
cookie_expire = "168h"
cookie_refresh = "1h"

## Session Configuration
# Use Redis for production (enables session sharing across instances)
# session_store_type = "redis"
# redis_connection_url = "redis://redis:6379"

## Authentication Settings
# Allow all authenticated users (customize for your needs)
email_domains = ["*"]

# Or restrict to specific domains:
# email_domains = ["yourcompany.com"]

# Or use allowed_groups for group-based access (requires group claim in token):
# allowed_groups = ["soliplex-users", "soliplex-admins"]

## OIDC Settings
oidc_email_claim = "email"
oidc_groups_claim = "groups"

# Request specific scopes
scope = "openid email profile"

# Skip OIDC discovery and set endpoints manually (optional)
# login_url = "https://idp.example.com/authorize"
# redeem_url = "https://idp.example.com/token"
# oidc_jwks_url = "https://idp.example.com/.well-known/jwks.json"

## Header Forwarding
# Pass user identity to upstream applications
set_xauthrequest = true
pass_access_token = true
pass_user_headers = true

# Set Authorization header with OIDC access token for authenticated users
# (CLI users with their own Bearer token will have theirs passed through instead)
set_authorization_header = true

## Skip Authentication for Specific Paths
# Health check and OpenAPI docs don't require auth
skip_auth_routes = [
    "^/health$",
    "^/api/v1/health$",
    "^/docs$",
    "^/redoc$",
    "^/openapi.json$"
]

## Logging
logging_filename = ""
logging_max_size = 100
logging_max_age = 7
logging_local_time = true
standard_logging = true
auth_logging = true
request_logging = true

## Security
# Skip SSL verification for development (set to false in production)
ssl_insecure_skip_verify = false

# Whitelist specific redirect URLs after login
# whitelist_domains = [".yourcompany.com"]

## API Token Support (for programmatic access)
# Allow requests with Bearer tokens to skip OIDC authentication
# The backend will validate the token instead
skip_auth_preflight = true

# Skip authentication for requests that already have an Authorization header
# This allows CLI clients to pass Bearer tokens directly through the proxy
skip_jwt_bearer_tokens = true

# Pass the original Authorization header to upstream (don't replace it)
pass_authorization_header = true
